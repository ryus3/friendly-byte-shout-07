import React, { useEffect } from 'react';
import { useInventory } from '@/contexts/InventoryContext';
import { supabase } from '@/integrations/supabase/client';

/**
 * Ù…ÙƒÙˆÙ† Ù…Ø³Ø§Ø¹Ø¯ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
 */
export const EditOrderDataLoader = ({ aiOrderData, isEditMode, onDataLoaded }) => {
  const { allData, addToCart, clearCart } = useInventory();

  useEffect(() => {
    if (!isEditMode || !aiOrderData?.items || !Array.isArray(aiOrderData.items)) {
      return;
    }

    console.log('ğŸ”§ EditOrderDataLoader - Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ¹Ø¯ÙŠÙ„');

    const loadRealProducts = async () => {
      // Ù…Ø³Ø­ Ø§Ù„Ø³Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹
      clearCart();

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      for (const item of aiOrderData.items) {
        if (item?.product_id && item?.variant_id) {
          console.log('ğŸ” ØªØ­Ù…ÙŠÙ„ Ù…Ù†ØªØ¬ Ø­Ù‚ÙŠÙ‚ÙŠ:', item);

          try {
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„Ù…ØªØºÙŠØ± Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const { data: productData, error: productError } = await supabase
              .from('products')
              .select(`
                *,
                product_variants!inner (
                  *,
                  colors (name, hex_code),
                  sizes (name),
                  inventory (quantity, reserved_quantity)
                )
              `)
              .eq('id', item.product_id)
              .eq('product_variants.id', item.variant_id)
              .single();

            if (productError) {
              console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', productError);
              throw new Error(productError.message);
            }

            if (productData && productData.product_variants?.[0]) {
              const realProduct = productData;
              const realVariant = productData.product_variants[0];
              
              console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
              
              // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù„Ø³Ù„Ø© Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„
              addToCart(realProduct, realVariant, item.quantity || 1, false);
            } else {
              throw new Error('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
          } catch (error) {
            console.log('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©...');
            
            // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø© ÙƒØ¨Ø¯ÙŠÙ„
            const realProduct = allData?.products?.find(p => p.id === item.product_id);
            const realVariant = allData?.product_variants?.find(v => v.id === item.variant_id);

            if (realProduct && realVariant) {
              console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©');
              addToCart(realProduct, realVariant, item.quantity || 1, false);
            } else {
              console.log('âš ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†ØªØ¬ Ù…Ø¤Ù‚Øª Ù„Ù„ØªØ¹Ø¯ÙŠÙ„');
              
              // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù†Ø§Øª Ù…Ø¤Ù‚ØªØ© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
              const tempProduct = {
                id: item.product_id,
                name: item.productName || item.product_name || 'Ù…Ù†ØªØ¬',
                images: [item.image || '/placeholder.svg'],
                price: item.unit_price || item.price || 0,
                cost_price: item.costPrice || item.cost_price || 0,
                is_temp: true // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
              };

              const tempVariant = {
                id: item.variant_id,
                product_id: item.product_id,
                sku: item.sku || '',
                colors: { name: item.color || '' },
                sizes: { name: item.size || '' },
                quantity: 999, // Ù…Ø®Ø²ÙˆÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ø§Ù„ÙŠ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
                reserved_quantity: 0,
                price: item.unit_price || item.price || 0,
                cost_price: item.costPrice || item.cost_price || 0,
                images: [item.image || '/placeholder.svg'],
                barcode: item.barcode || '',
                is_temp: true // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
              };

              addToCart(tempProduct, tempVariant, item.quantity || 1, false);
            }
          }
        }
      }

      // Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
      if (onDataLoaded) {
        onDataLoaded();
      }
      
      console.log('âœ… EditOrderDataLoader - ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„ØªØ¹Ø¯ÙŠÙ„');
    };

    loadRealProducts();
  }, [isEditMode, aiOrderData, allData, addToCart, clearCart, onDataLoaded]);

  // Ù‡Ø°Ø§ Ø§Ù„Ù…ÙƒÙˆÙ† Ù„Ø§ ÙŠØ¹Ø±Ø¶ Ø´ÙŠØ¦Ø§Ù‹ - ÙÙ‚Ø· ÙŠØ­Ù…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  return null;
};

export default EditOrderDataLoader;