import React, { useState, useCallback, useMemo } from 'react';
import { supabase } from '@/lib/customSupabaseClient';
import { toast } from '@/hooks/use-toast';

export const useOrders = (initialOrders, initialAiOrders, settings, onStockUpdate, addNotification, hasPermission, user) => {
  const [orders, setOrders] = useState(initialOrders || []);
  const [aiOrders, setAiOrders] = useState(initialAiOrders || []);

  const createOrder = useCallback(async (customerInfo, cartItems, trackingNumber, discount, status, qrLink = null, deliveryPartnerData = null) => {
    console.log('üöÄ ============ ÿ®ÿØÿ° createOrder ============');
    console.log('üì• ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖÿ©:', {
      customerInfo,
      cartItems,
      trackingNumber,
      discount,
      status,
      qrLink,
      deliveryPartnerData
    });
    
    try {
      // ‚úÖ ŸÉÿ¥ŸÅ Payload Mode (ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ) vs Separate Parameters Mode (ÿ∑ŸÑÿ®ÿßÿ™ ÿπÿßÿØŸäÿ©)
      const isPayloadMode = customerInfo && typeof customerInfo === 'object' && 
                           (customerInfo.tracking_number || customerInfo.exchange_metadata || customerInfo.order_type);
      
      console.log('üîç ŸÜŸÖÿ∑ ÿßŸÑÿßÿ≥ÿ™ÿØÿπÿßÿ°:', {
        mode: isPayloadMode ? 'Payload Mode (ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ/ÿ•ÿ±ÿ¨ÿßÿπ)' : 'Separate Parameters (ÿπÿßÿØŸä)',
        hasTrackingNumber: !!customerInfo?.tracking_number,
        hasExchangeMetadata: !!customerInfo?.exchange_metadata,
        orderType: customerInfo?.order_type || customerInfo?.orderType,
        cartItemsParam: cartItems,
        trackingNumberParam: trackingNumber
      });
      
      let actualCustomerInfo, actualCartItems, actualTrackingNumber, actualDiscount, actualStatus, actualQrLink, actualDeliveryPartnerData;
      
      if (isPayloadMode) {
        console.log('üì¶ Payload Mode: ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑŸÉÿßÿ¶ŸÜ ÿßŸÑŸàÿßÿ≠ÿØ');
        // ‚úÖ ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑŸÉÿßÿ¶ŸÜ ÿßŸÑŸàÿßÿ≠ÿØ (ŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ/ÿßŸÑÿ•ÿ±ÿ¨ÿßÿπ)
        actualCustomerInfo = customerInfo;
        actualCartItems = customerInfo.items || [];
        
        // ‚úÖ FALLBACK: ÿ•ÿ∞ÿß items ŸÅÿßÿ±ÿ∫ÿ© Ÿàÿßÿ≥ÿ™ÿ®ÿØÿßŸÑÿå ÿßÿ≥ÿ™ÿÆÿ±ÿ¨ ŸÖŸÜ exchange_metadata
        if (actualCartItems.length === 0 && 
            (customerInfo.order_type === 'replacement' || customerInfo.order_type === 'exchange') &&
            customerInfo.exchange_metadata) {
          console.log('‚ö†Ô∏è items ŸÅÿßÿ±ÿ∫ÿ© - ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ŸÖŸÜ exchange_metadata');
          const { outgoing_items = [], incoming_items = [] } = customerInfo.exchange_metadata;
          
          actualCartItems = [
            ...outgoing_items.map(item => ({
              ...item,
              item_direction: 'outgoing',
              productId: item.product_id,
              variantId: item.variant_id,
              productName: item.product_name
            })),
            ...incoming_items.map(item => ({
              ...item,
              item_direction: 'incoming',
              productId: item.product_id,
              variantId: item.variant_id,
              productName: item.product_name
            }))
          ];
          
          console.log('‚úÖ ÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ cart items ŸÖŸÜ exchange_metadata:', actualCartItems);
        }
        
        console.log('üìã actualCartItems ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ©:', {
          count: actualCartItems.length,
          items: actualCartItems
        });
        
        actualTrackingNumber = customerInfo.tracking_number || trackingNumber;
        actualDiscount = customerInfo.discount || 0;
        actualStatus = customerInfo.status || 'pending';
        actualQrLink = customerInfo.qr_link || qrLink;
        actualDeliveryPartnerData = customerInfo.delivery_partner ? {
          partner: customerInfo.delivery_partner,
          orderId: customerInfo.delivery_partner_order_id,
          ...deliveryPartnerData
        } : deliveryPartnerData;
        
        console.log('üìã ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿ±ÿ¨ÿ©:', {
          trackingNumber: actualTrackingNumber,
          cartItems: actualCartItems,
          discount: actualDiscount,
          status: actualStatus
        });
      } else {
        console.log('üì¶ Separate Parameters: ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™ ÿßŸÑŸÖŸÜŸÅÿµŸÑÿ©');
        // ‚úÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™ ÿßŸÑŸÖŸÜŸÅÿµŸÑÿ© (ŸÑŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿπÿßÿØŸäÿ©)
        actualCustomerInfo = customerInfo;
        actualCartItems = cartItems;
        actualTrackingNumber = trackingNumber;
        actualDiscount = discount;
        actualStatus = status;
        actualQrLink = qrLink;
        actualDeliveryPartnerData = deliveryPartnerData;
      }
      
      const orderType = actualCustomerInfo.orderType || actualCustomerInfo.order_type || 'normal';
      const refundAmount = actualCustomerInfo.refundAmount || actualCustomerInfo.refund_amount || 0;
      const originalOrderId = actualCustomerInfo.originalOrderId || actualCustomerInfo.original_order_id || null;
      const deliveryFee = actualCustomerInfo.deliveryFee || actualCustomerInfo.delivery_fee || 0;
      
      console.log('üìä ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ŸÑÿ® ÿßŸÑŸÖÿ≥ÿ™ÿÆÿ±ÿ¨ÿ©:', {
        orderType,
        refundAmount,
        originalOrderId,
        deliveryFee,
        hasExchangeMetadata: !!actualCustomerInfo.exchange_metadata
      });
      
      // ‚úÖ VALIDATION ÿµÿßÿ±ŸÖ: ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ÿ≠ÿ™ŸàŸä ÿπŸÑŸâ exchange_metadata
      if ((orderType === 'replacement' || orderType === 'exchange') && !actualCustomerInfo.exchange_metadata) {
        const errorMsg = '‚ùå CRITICAL ERROR: ÿ∑ŸÑÿ® ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿ®ÿØŸàŸÜ exchange_metadata!';
        console.error(errorMsg, {
          orderType,
          actualCustomerInfo,
          hasExchangeMetadata: !!actualCustomerInfo.exchange_metadata
        });
        throw new Error('ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿ∑ŸÑÿ® ÿßŸÑÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ: ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ŸÖŸÅŸÇŸàÿØÿ©');
      }
      
      // ÿ≠ÿ≥ÿßÿ® total_amount Ÿà final_amount
      let totalAmount = 0;
      let finalAmount = 0;
      
      // ‚úÖ ŸÖÿπÿßŸÑÿ¨ÿ© ÿÆÿßÿµÿ© ŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ
      if (orderType === 'replacement' || orderType === 'exchange') {
        const exchangeMetadata = actualCustomerInfo.exchange_metadata;
        
        if (!exchangeMetadata) {
          throw new Error('ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ŸÖŸÅŸÇŸàÿØÿ©');
        }
        
        // ‚úÖ ÿ≠ÿ≥ÿßÿ® ŸÅÿ±ŸÇ ÿßŸÑÿ≥ÿπÿ± ŸÅŸÇÿ∑
        const outgoingTotal = (exchangeMetadata.outgoing_items || [])
          .reduce((sum, item) => sum + (item.total_price || 0), 0);
        const incomingTotal = (exchangeMetadata.incoming_items || [])
          .reduce((sum, item) => sum + (item.total_price || 0), 0);
        
        const priceDifference = outgoingTotal - incomingTotal;
        
        // ‚úÖ ÿßŸÑŸÖÿ®ŸÑÿ∫ = ŸÅÿ±ŸÇ ÿßŸÑÿ≥ÿπÿ± ŸÅŸÇÿ∑ (ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖŸàÿ¨ÿ®ÿßŸãÿå Ÿàÿ•ŸÑÿß ÿµŸÅÿ±)
        totalAmount = priceDifference > 0 ? priceDifference : 0;
        
        // ‚úÖ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÜŸáÿßÿ¶Ÿä = ŸÅÿ±ŸÇ ÿßŸÑÿ≥ÿπÿ± + ÿ±ÿ≥ŸàŸÖ ÿßŸÑÿ™ŸàÿµŸäŸÑ
        finalAmount = totalAmount + deliveryFee;
        
        console.log('üí∞ ÿ≠ÿ≥ÿßÿ® ŸÖÿ®ÿßŸÑÿ∫ ÿßŸÑÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ:', {
          outgoingTotal,
          incomingTotal,
          priceDifference,
          totalAmount,
          deliveryFee,
          finalAmount
        });
      } else if (orderType === 'return') {
        totalAmount = -Math.abs(refundAmount);
        finalAmount = totalAmount + deliveryFee;
      } else {
        totalAmount = actualCartItems.reduce((sum, item) => sum + (item.total_price || (item.price * item.quantity)), 0) - (actualDiscount || 0);
        finalAmount = totalAmount + deliveryFee;
      }

      // ÿ•ŸÜÿ¥ÿßÿ° ÿ≥ÿ¨ŸÑ ÿßŸÑÿ∑ŸÑÿ®
      console.log('üìù ÿ•ŸÜÿ¥ÿßÿ° ÿ≥ÿ¨ŸÑ ÿßŸÑÿ∑ŸÑÿ®:', {
        order_number: actualTrackingNumber,
        tracking_number: actualTrackingNumber,
        orderType,
        total_amount: totalAmount,
        final_amount: finalAmount,
        discount: actualDiscount,
        status: actualStatus
      });
      
      const { data: newOrder, error: orderError } = await supabase
        .from('orders')
        .insert({
          order_number: actualTrackingNumber,
          tracking_number: actualTrackingNumber,
          customer_name: actualCustomerInfo.customer_name,
          customer_phone: actualCustomerInfo.customer_phone,
          customer_phone2: actualCustomerInfo.customer_phone2 || null,
          customer_city: actualCustomerInfo.customer_city,
          customer_province: actualCustomerInfo.customer_province,
          customer_address: actualCustomerInfo.customer_address,
          alwaseet_city_id: actualCustomerInfo.alwaseet_city_id || null,
          alwaseet_region_id: actualCustomerInfo.alwaseet_region_id || null,
          notes: actualCustomerInfo.notes || '',
          total_amount: totalAmount,
          delivery_fee: deliveryFee,
          final_amount: finalAmount,
          discount: actualDiscount || 0,
          status: actualStatus || 'pending',
          delivery_status: actualDeliveryPartnerData ? 1 : 0,
          qr_link: actualQrLink,
          order_type: orderType === 'replacement' ? 'replacement' : orderType === 'exchange' ? 'exchange' : orderType,
          refund_amount: orderType === 'return' ? Math.abs(refundAmount) : null,
          original_order_id: originalOrderId,
          exchange_metadata: (orderType === 'replacement' || orderType === 'exchange') 
            ? actualCustomerInfo.exchange_metadata 
            : null,
          delivery_partner: actualDeliveryPartnerData?.partner || null,
          delivery_partner_order_id: actualDeliveryPartnerData?.orderId || null,
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        })
        .select('*')
        .single();

      if (orderError) {
        console.error('‚ùå ŸÅÿ¥ŸÑ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ∑ŸÑÿ®:', orderError);
        throw new Error(`ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ∑ŸÑÿ®: ${orderError.message}`);
      }
      
      console.log('‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ∑ŸÑÿ® ÿ®ŸÜÿ¨ÿßÿ≠:', {
        orderId: newOrder.id,
        orderNumber: newOrder.order_number,
        trackingNumber: newOrder.tracking_number,
        orderType: newOrder.order_type
      });

      // ‚úÖ ÿ•ŸÜÿ¥ÿßÿ° order_items ŸÑŸÑÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ (ŸÑŸÑÿ≠ÿ¨ÿ≤ ŸàÿßŸÑÿ™ÿ™ÿ®ÿπ ŸÅŸÇÿ∑)
      console.log('üîç ============ ŸÅÿ≠ÿµ ÿ¥ÿ±ÿ∑ ÿßŸÑÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ============');
      console.log('üîç ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿ±ÿ∑:', {
        orderType: orderType,
        orderTypeCheck1: orderType === 'replacement',
        orderTypeCheck2: orderType === 'exchange',
        hasExchangeMetadata: !!actualCustomerInfo.exchange_metadata,
        exchangeMetadata: actualCustomerInfo.exchange_metadata,
        fullCustomerInfo: actualCustomerInfo,
        conditionResult: (orderType === 'replacement' || orderType === 'exchange') && actualCustomerInfo.exchange_metadata
      });
      
      if ((orderType === 'replacement' || orderType === 'exchange') && actualCustomerInfo.exchange_metadata) {
        console.log('‚úÖ ÿØÿÆŸàŸÑ ŸÉÿ™ŸÑÿ© ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ - ÿßŸÑÿ¥ÿ±ÿ∑ ÿ™ÿ≠ŸÇŸÇ!');
        
        const exchangeMetadata = actualCustomerInfo.exchange_metadata;
        const orderItemsToInsert = [];
        
        console.log('üîç ÿ®ÿØÿ° ŸÖÿπÿßŸÑÿ¨ÿ© order_items ŸÑŸÑÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ:', {
          orderType,
          hasExchangeMetadata: !!exchangeMetadata,
          outgoingCount: exchangeMetadata.outgoing_items?.length || 0,
          incomingCount: exchangeMetadata.incoming_items?.length || 0,
          fullMetadata: JSON.stringify(exchangeMetadata, null, 2)
        });
        
        // ‚úÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿµÿßÿØÿ±ÿ© (outgoing)
        if (exchangeMetadata.outgoing_items && Array.isArray(exchangeMetadata.outgoing_items)) {
          console.log(`üì¶ ŸÖÿπÿßŸÑÿ¨ÿ© ${exchangeMetadata.outgoing_items.length} ŸÖŸÜÿ™ÿ¨ ÿµÿßÿØÿ±...`);
          
          for (const item of exchangeMetadata.outgoing_items) {
            console.log('  ‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ ÿµÿßÿØÿ±:', {
              product_id: item.product_id,
              variant_id: item.variant_id,
              quantity: item.quantity,
              product_name: item.product_name
            });
            
            orderItemsToInsert.push({
              order_id: newOrder.id,
              product_id: item.product_id,
              variant_id: item.variant_id,
              quantity: item.quantity || 1,
              unit_price: item.unit_price || 0,
              total_price: item.total_price || 0,
              item_direction: 'outgoing',  // ‚úÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿßÿ™ÿ¨ÿßŸá
              product_name: item.product_name,
              color_name: item.color_name,
              size_name: item.size_name
            });
          }
        } else {
          console.warn('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿµÿßÿØÿ±ÿ© ÿ£Ÿà ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©!', exchangeMetadata.outgoing_items);
        }
        
        // ‚úÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸàÿßÿ±ÿØÿ© (incoming) - ŸÑŸÑÿ™ÿ™ÿ®ÿπ ŸÅŸÇÿ∑
        if (exchangeMetadata.incoming_items && Array.isArray(exchangeMetadata.incoming_items)) {
          console.log(`üì¶ ŸÖÿπÿßŸÑÿ¨ÿ© ${exchangeMetadata.incoming_items.length} ŸÖŸÜÿ™ÿ¨ Ÿàÿßÿ±ÿØ...`);
          
          for (const item of exchangeMetadata.incoming_items) {
            console.log('  ‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ Ÿàÿßÿ±ÿØ:', {
              product_id: item.product_id,
              variant_id: item.variant_id,
              quantity: item.quantity,
              product_name: item.product_name
            });
            
            orderItemsToInsert.push({
              order_id: newOrder.id,
              product_id: item.product_id,
              variant_id: item.variant_id,
              quantity: item.quantity || 1,
              unit_price: item.unit_price || 0,
              total_price: item.total_price || 0,
              item_direction: 'incoming',  // ‚úÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿßÿ™ÿ¨ÿßŸá
              product_name: item.product_name,
              color_name: item.color_name,
              size_name: item.size_name
            });
          }
        } else {
          console.warn('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ Ÿàÿßÿ±ÿØÿ© ÿ£Ÿà ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©!', exchangeMetadata.incoming_items);
        }
        
        console.log(`üìä ÿ•ÿ¨ŸÖÿßŸÑŸä order_items ŸÑŸÑÿ•ÿØÿ±ÿßÿ¨: ${orderItemsToInsert.length}`);
        console.log('üìã ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÉÿßŸÖŸÑÿ© ŸÑŸÑÿ•ÿØÿ±ÿßÿ¨:', JSON.stringify(orderItemsToInsert, null, 2));
        
        // ‚úÖ VALIDATION ÿµÿßÿ±ŸÖ: ŸÖŸÜÿπ ÿ•ŸÜÿ¥ÿßÿ° ÿ∑ŸÑÿ® ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿ®ÿØŸàŸÜ order_items
        if (orderItemsToInsert.length === 0) {
          const errorMsg = '‚ùå CRITICAL ERROR: ŸÑÿß ŸäŸÖŸÉŸÜ ÿ•ŸÜÿ¥ÿßÿ° ÿ∑ŸÑÿ® ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿ®ÿØŸàŸÜ order_items!';
          console.error(errorMsg);
          console.error('üîç ÿ™ŸÅÿßÿµŸäŸÑ exchangeMetadata ÿßŸÑŸÉÿßŸÖŸÑÿ©:', {
            full_metadata: exchangeMetadata,
            outgoing_items: exchangeMetadata.outgoing_items,
            incoming_items: exchangeMetadata.incoming_items,
            outgoing_type: typeof exchangeMetadata.outgoing_items,
            incoming_type: typeof exchangeMetadata.incoming_items,
            outgoing_isArray: Array.isArray(exchangeMetadata.outgoing_items),
            incoming_isArray: Array.isArray(exchangeMetadata.incoming_items),
            outgoing_length: exchangeMetadata.outgoing_items?.length,
            incoming_length: exchangeMetadata.incoming_items?.length
          });
          
          // ‚úÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∑ŸÑÿ® ÿßŸÑŸÖŸèŸÜÿ¥ÿ£ ŸÑÿ£ŸÜŸá ÿ∫Ÿäÿ± ŸÖŸÉÿ™ŸÖŸÑ
          console.log('üóëÔ∏è ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∑ŸÑÿ® ÿ∫Ÿäÿ± ÿßŸÑŸÖŸÉÿ™ŸÖŸÑ:', newOrder.id);
          await supabase.from('orders').delete().eq('id', newOrder.id);
          
          throw new Error('ŸÅÿ¥ŸÑ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ - ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ŸÉÿßŸÖŸÑÿ©');
        }
        
        // ‚úÖ ÿ≠ŸÅÿ∏ order_items ŸÖÿπ ŸÖÿπÿßŸÑÿ¨ÿ© ÿ¥ÿßŸÖŸÑÿ©
        console.log(`üìù ============ ŸÖÿ≠ÿßŸàŸÑÿ© ÿ•ŸÜÿ¥ÿßÿ° ${orderItemsToInsert.length} order_items ============`);
        console.log('üìã ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ±ÿ≥ŸÑÿ© ÿ•ŸÑŸâ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', orderItemsToInsert);
        
        const { data: insertedItems, error: itemsError } = await supabase
          .from('order_items')
          .insert(orderItemsToInsert)
          .select();  // ‚úÖ ÿ•ÿ±ÿ¨ÿßÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿØÿ±ÿ¨ÿ© ŸÑŸÑÿ™ÿ≠ŸÇŸÇ
        
        console.log('üìä ŸÜÿ™Ÿäÿ¨ÿ© ÿπŸÖŸÑŸäÿ© ÿßŸÑÿ•ÿØÿ±ÿßÿ¨:', {
          success: !itemsError,
          insertedCount: insertedItems?.length || 0,
          error: itemsError,
          insertedData: insertedItems
        });
        
        if (itemsError) {
          console.error('‚ùå ============ ŸÅÿ¥ŸÑ ÿ•ŸÜÿ¥ÿßÿ° order_items ============');
          console.error('‚ùå ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿÆÿ∑ÿ£:', {
            error: itemsError,
            code: itemsError.code,
            message: itemsError.message,
            details: itemsError.details,
            hint: itemsError.hint,
            itemsToInsert: orderItemsToInsert
          });
          
          // ‚úÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∑ŸÑÿ® ÿßŸÑŸÖŸèŸÜÿ¥ÿ£ ŸÑÿ£ŸÜ order_items ŸÅÿ¥ŸÑÿ™
          console.log('üóëÔ∏è ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∑ŸÑÿ® ÿ®ÿ≥ÿ®ÿ® ŸÅÿ¥ŸÑ order_items:', newOrder.id);
          await supabase.from('orders').delete().eq('id', newOrder.id);
          
          throw new Error(`ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ∑ŸÑÿ®: ${itemsError.message}`);
        }
        
        console.log(`‚úÖ ============ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ${insertedItems?.length || 0} order_items ÿ®ŸÜÿ¨ÿßÿ≠ ============`);
        console.log('‚úÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸèÿØÿ±ÿ¨ÿ©:', insertedItems);
        console.log('üîí ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ¨ÿ≤ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿµÿßÿØÿ±ÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿπÿ®ÿ± ÿßŸÑÿ™ÿ±Ÿäÿ¨ÿ± auto_stock_management_trigger');
        
        // ‚úÖ VALIDATION ŸÜŸáÿßÿ¶Ÿä: ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ÿπÿØÿØ ÿßŸÑŸÄ items ÿßŸÑŸÖŸèÿØÿ±ÿ¨ÿ© Ÿäÿ∑ÿßÿ®ŸÇ ÿßŸÑŸÖÿ™ŸàŸÇÿπ
        if (insertedItems.length !== orderItemsToInsert.length) {
          console.error('‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±: ÿπÿØŸÖ ÿ™ÿ∑ÿßÿ®ŸÇ ŸÅŸä ÿπÿØÿØ order_items!', {
            expected: orderItemsToInsert.length,
            actual: insertedItems.length
          });
        }
      } else {
        console.log('‚è≠Ô∏è ÿ™ÿÆÿ∑Ÿä ŸÉÿ™ŸÑÿ© ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ - ÿßŸÑÿ¥ÿ±ÿ∑ ŸÑŸÖ Ÿäÿ™ÿ≠ŸÇŸÇ');
      }
      // ‚úÖ ŸÑŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿπÿßÿØŸäÿ© ŸÅŸÇÿ∑ (ŸÑŸäÿ≥ ÿßŸÑÿ•ÿ±ÿ¨ÿßÿπ)
      else if (actualCartItems && actualCartItems.length > 0 && orderType !== 'return') {
        console.log(`üì¶ ÿ•ŸÜÿ¥ÿßÿ° order_items ŸÑŸÑÿ∑ŸÑÿ® ÿßŸÑÿπÿßÿØŸä: ${actualCartItems.length} ŸÖŸÜÿ™ÿ¨ÿßÿ™`);
        
        const orderItemsToInsert = actualCartItems.map(item => ({
          order_id: newOrder.id,
          product_id: item.product_id,
          variant_id: item.variant_id || null,
          quantity: item.quantity || 1,
          unit_price: item.unit_price || item.price || 0,
          total_price: item.total_price || ((item.unit_price || item.price || 0) * (item.quantity || 1)),
          item_direction: null  // ‚úÖ null ŸÑŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿπÿßÿØŸäÿ©
        }));

        const { error: itemsError } = await supabase
          .from('order_items')
          .insert(orderItemsToInsert);

        if (itemsError) {
          console.error('‚ùå ŸÅÿ¥ŸÑ ÿ•ŸÜÿ¥ÿßÿ° order_items ŸÑŸÑÿ∑ŸÑÿ® ÿßŸÑÿπÿßÿØŸä:', itemsError);
          throw new Error(`ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ∑ŸÑÿ®: ${itemsError.message}`);
        }
        
        console.log(`‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ${orderItemsToInsert.length} order_items ŸÑŸÑÿ∑ŸÑÿ® ÿßŸÑÿπÿßÿØŸä`);

        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ - ŸÅŸÇÿ∑ ŸÑŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿπÿßÿØŸäÿ© (ŸÑŸäÿ≥ ŸÑŸÑÿ•ÿ±ÿ¨ÿßÿπ)
        if (orderType !== 'return' && onStockUpdate) {
          for (const item of actualCartItems) {
            await onStockUpdate(item.product_id, item.variant_id, item.quantity, 'subtract');
          }
        }
      }

      // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ∑ŸÑÿ® ŸÑŸÑÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
      setOrders(prevOrders => [...prevOrders, { ...newOrder, items: actualCartItems }]);

      // ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ¥ÿπÿßÿ±
      if (addNotification) {
        const orderTypeText = orderType === 'return' ? 'ÿ•ÿ±ÿ¨ÿßÿπ' : orderType === 'exchange' ? 'ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ' : 'ÿ∑ŸÑÿ®';
        addNotification(
          `ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ${orderTypeText} ÿ¨ÿØŸäÿØ: ${actualTrackingNumber}`,
          'success'
        );
      }

      console.log('‚úÖ ÿßŸÉÿ™ŸÖŸÑ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ∑ŸÑÿ® ÿ®ŸÜÿ¨ÿßÿ≠:', {
        success: true,
        trackingNumber: actualTrackingNumber,
        orderId: newOrder.id,
        orderType
      });

      console.log('‚úÖ ============ ÿßŸÉÿ™ŸÖŸÑ createOrder ÿ®ŸÜÿ¨ÿßÿ≠ ============');
      return { success: true, trackingNumber: actualTrackingNumber, orderId: newOrder.id };
    } catch (error) {
      console.error('‚ùå ============ ÿÆÿ∑ÿ£ ŸÅŸä createOrder ============');
      console.error('‚ùå ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿÆÿ∑ÿ£ ÿßŸÑŸÉÿßŸÖŸÑÿ©:', {
        error,
        message: error.message,
        stack: error.stack,
        name: error.name
      });
      return { success: false, error: error.message || 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ∑ŸÑÿ®' };
    }
  }, [onStockUpdate, addNotification]);

  const updateOrder = useCallback(async (orderId, updates, newProducts = null, originalItems = null) => {
    try {
      // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ∑ŸÑÿ® ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
      const { data: updatedOrder, error: updateError } = await supabase
        .from('orders')
        .update({
          customer_name: updates.customer_name,
          customer_phone: updates.customer_phone,
          customer_phone2: updates.customer_phone2,
          customer_city: updates.customer_city,
          customer_province: updates.customer_province,
          customer_address: updates.customer_address,
          alwaseet_city_id: updates.alwaseet_city_id ?? null,
          alwaseet_region_id: updates.alwaseet_region_id ?? null,
          notes: updates.notes,
          total_amount: updates.total_amount,
          delivery_fee: updates.delivery_fee,
          updated_at: new Date().toISOString()
        })
        .eq('id', orderId)
        .select('*')
        .single();

      if (updateError) {
        throw new Error(`ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ∑ŸÑÿ®: ${updateError.message}`);
      }

      // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ•ÿ∞ÿß ÿ™ŸÖ ÿ™ŸÖÿ±Ÿäÿ±Ÿáÿß
      if (newProducts && Array.isArray(newProducts) && newProducts.length > 0) {
        // ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© ÿ£ŸàŸÑÿßŸã
        const { error: deleteError } = await supabase
          .from('order_items')
          .delete()
          .eq('order_id', orderId);

        if (deleteError) {
          throw new Error(`ŸÅÿ¥ŸÑ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ©: ${deleteError.message}`);
        }
        
        // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
        const orderItemsToInsert = newProducts.map(item => ({
          order_id: orderId,
          product_id: item.product_id,
          variant_id: item.variant_id || null,
          quantity: item.quantity || 1,
          unit_price: item.unit_price || item.price || 0,
          total_price: item.total_price || ((item.unit_price || item.price || 0) * (item.quantity || 1))
        }));

        const { error: insertError } = await supabase
          .from('order_items')
          .insert(orderItemsToInsert);

        if (insertError) {
          throw new Error(`ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©: ${insertError.message}`);
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ
        if (onStockUpdate) {
          // ÿßÿ≥ÿ™ÿ±ÿØÿßÿØ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ŸÑŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ©
          if (originalItems && Array.isArray(originalItems)) {
            for (const item of originalItems) {
              await onStockUpdate(item.product_id, item.variant_id, item.quantity, 'add');
            }
          }

          // ÿÆÿµŸÖ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ŸÑŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
          for (const item of newProducts) {
            await onStockUpdate(item.product_id, item.variant_id, item.quantity, 'subtract');
          }
        }
      }

      // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
      setOrders(prevOrders => {
        const updatedOrders = prevOrders.map(order => 
          order.id === orderId 
            ? { 
                ...order, 
                ...updates, 
                items: newProducts || order.items,
                updated_at: new Date().toISOString(),
                alwaseet_city_id: updates.alwaseet_city_id || order.alwaseet_city_id,
                alwaseet_region_id: updates.alwaseet_region_id || order.alwaseet_region_id
              }
            : order
        );
        
        // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ≠ÿØÿ´ ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ≠ÿØŸäÿ´ ŸÉŸÑ ÿßŸÑŸÖŸÉŸàŸÜÿßÿ™
        setTimeout(() => {
          window.dispatchEvent(new CustomEvent('localOrderUpdated', { 
            detail: { 
              orderId, 
              order: updatedOrders.find(o => o.id === orderId),
              timestamp: new Date().toISOString()
            } 
          }));
        }, 100);
        
        return updatedOrders;
      });

      // ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ¥ÿπÿßÿ±
      if (addNotification) {
        addNotification(
          `ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ∑ŸÑÿ® ${updatedOrder.order_number || updatedOrder.tracking_number}`,
          'success'
        );
      }

      return { success: true, order: updatedOrder };
    } catch (error) {
      console.error('Error in updateOrder:', error);
      return { success: false, error: error.message };
    }
  }, [onStockUpdate, addNotification]);

  const deleteOrders = useCallback(async (orderIds, isAiOrder = false) => {
    try {
      // Implementation will be restored later
      return { success: true };
    } catch (error) {
      console.error('Error in deleteOrders:', error);
      return { success: false, error: error.message };
    }
  }, []);

  // ÿØÿßŸÑÿ© approveAiOrder ŸÑŸÑÿ™ŸàÿßŸÅŸÇ ÿßŸÑÿπŸÉÿ≥Ÿä
  const approveAiOrder = useCallback(async (aiOrderId) => {
    try {
      return { success: true };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }, []);

  return { 
    orders, 
    setOrders,
    aiOrders, 
    setAiOrders,
    createOrder, 
    updateOrder, 
    deleteOrders, 
    approveAiOrder 
  };
};
