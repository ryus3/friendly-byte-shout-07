import { useEffect, useState, useCallback } from 'react';
import { useLocalStorage } from '@/hooks/useLocalStorage';
import { useAlWaseet } from '@/contexts/AlWaseetContext';
import { supabase } from '@/lib/customSupabaseClient';
import { toast } from '@/hooks/use-toast';

/**
 * Hook for handling comprehensive app start synchronization
 * Runs comprehensive sync once per app session
 */
export const useAppStartSync = () => {
  const { token, isLoggedIn, activePartner } = useAlWaseet();
  const [syncSettings] = useLocalStorage('delivery-invoice-sync-settings', {
    enabled: true,
    autoSyncOnAppStart: true,
    comprehensiveOnStart: true
  });
  const [lastAppStartSync, setLastAppStartSync] = useLocalStorage('app-start-sync', null);
  const [sessionSynced, setSessionSynced] = useLocalStorage('session-synced', false);
  const [syncing, setSyncing] = useState(false);
  const [isAutoSync, setIsAutoSync] = useState(false); // Ù…Ø¹Ø±ÙØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
  const [syncProgress, setSyncProgress] = useState({ current: 0, total: 0, status: '' });

  // Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ - Ù…Ø­Ø³Ù†Ø© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… syncVisibleOrdersBatch
  const performComprehensiveSync = useCallback(async (visibleOrders = null, syncVisibleOrdersBatch = null, autoSync = false) => {
    if (syncing) return;
    
    setSyncing(true);
    setIsAutoSync(autoSync); // ØªØ­Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
    setSyncProgress({ current: 0, total: 4, status: 'Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©...' });
    
    try {
      console.log('ðŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø© Ø§Ù„Ø°ÙƒÙŠØ© Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚');

      // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ø¨Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ù‚ØµÙˆÙ‰
      setSyncProgress({ current: 1, total: 3, status: 'Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ©...' });
      let ordersUpdated = 0;
      
      if (visibleOrders && Array.isArray(visibleOrders) && visibleOrders.length > 0 && syncVisibleOrdersBatch) {
        console.log(`ðŸ“‹ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ©: ${visibleOrders.length} Ø·Ù„Ø¨`);
        
        const ordersResult = await syncVisibleOrdersBatch(visibleOrders, (progress) => {
          console.log(`ðŸ“Š ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ${progress.processed}/${progress.total} Ù…ÙˆØ¸ÙÙŠÙ†ØŒ ${progress.updated} Ø·Ù„Ø¨ Ù…Ø­Ø¯Ø«`);
        });
        
        if (ordersResult.success) {
          ordersUpdated = ordersResult.updatedCount || 0;
          console.log(`âœ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ©: ${ordersUpdated} Ø·Ù„Ø¨ Ù…Ø­Ø¯Ø«`);
        }
      }

      // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
      setSyncProgress({ current: 2, total: 3, status: 'ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©...' });
      await supabase.rpc('cleanup_old_delivery_invoices');

      // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¬Ø§Ø­
      setSyncProgress({ current: 3, total: 3, status: 'Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...' });
      
      const totalInvoices = 0; // Ù„Ø§ ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©
      
      console.log(`âœ… Ù…Ø²Ø§Ù…Ù†Ø© Ø´Ø§Ù…Ù„Ø© Ø°ÙƒÙŠØ© Ù…ÙƒØªÙ…Ù„Ø©: ${totalInvoices} ÙØ§ØªÙˆØ±Ø©ØŒ ${ordersUpdated} Ø·Ù„Ø¨`);
      
      // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¬Ø§Ø­ Ù…Ø­Ø³Ù† ÙÙ‚Ø· Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
      if (!autoSync) {
        toast({
          title: "ðŸŽ‰ Ù…Ø²Ø§Ù…Ù†Ø© Ø´Ø§Ù…Ù„Ø© Ø°ÙƒÙŠØ© Ù…ÙƒØªÙ…Ù„Ø©",
          description: `ØªÙ… ØªØ­Ø¯ÙŠØ« ${ordersUpdated} Ø·Ù„Ø¨ ÙˆØ¬Ù„Ø¨ ${totalInvoices} ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­`,
          variant: "default",
          duration: 8000
        });
      }

      // ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
      setLastAppStartSync(Date.now());
      setSessionSynced(true);

      // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø© Ù„Ù„Ù†Ø¸Ø§Ù… Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ø³Ù†Ø©
      window.dispatchEvent(new CustomEvent('comprehensiveSyncCompleted', { 
        detail: { 
          invoices: totalInvoices, 
          orders: ordersUpdated,
          smartSync: true,
          timestamp: new Date().toISOString()
        } 
      }));

    } catch (error) {
      console.error('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø© Ø§Ù„Ø°ÙƒÙŠØ©:', error);
      toast({
        title: "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©",
        description: error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹',
        variant: "destructive",
        duration: 6000
      });
    } finally {
      setSyncing(false);
      setIsAutoSync(false); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
      setSyncProgress({ current: 0, total: 0, status: '' });
    }
  }, [syncing, setLastAppStartSync, setSessionSynced]);

  useEffect(() => {
    const checkAndPerformSync = async () => {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
      if (
        !syncSettings.enabled || 
        !syncSettings.autoSyncOnAppStart ||
        !token || 
        !isLoggedIn || 
        activePartner !== 'alwaseet' ||
        sessionSynced
      ) {
        return;
      }

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø© (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹)
      const today = new Date().toDateString();
      const lastSyncDate = lastAppStartSync ? new Date(lastAppStartSync).toDateString() : null;
      
      if (lastSyncDate === today) {
        setSessionSynced(true);
        return;
      }

      // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ù†Ø¸Ø§Ù… - Ù…Ø¹ ØªÙ…Ø±ÙŠØ± true Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
      const timeoutId = setTimeout(() => performComprehensiveSync(null, null, true), 2000);
      
      return () => clearTimeout(timeoutId);
    };

    checkAndPerformSync();
  }, [token, isLoggedIn, activePartner, syncSettings, lastAppStartSync, sessionSynced, performComprehensiveSync]);

  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
  useEffect(() => {
    const handleBeforeUnload = () => {
      setSessionSynced(false);
    };

    window.addEventListener('beforeunload', handleBeforeUnload);
    return () => window.removeEventListener('beforeunload', handleBeforeUnload);
  }, [setSessionSynced]);

  return { 
    syncing, 
    syncProgress,
    performComprehensiveSync,
    sessionSynced,
    isAutoSync
  };
};