/**
 * SuperProvider - Ù…Ø²ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ­Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
 * ÙŠØ³ØªØ¨Ø¯Ù„ InventoryContext Ø¨Ù†Ø¸Ø§Ù… Ø£ÙƒØ«Ø± ÙƒÙØ§Ø¡Ø© Ù…Ø¹ Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØªØºÙŠÙŠØ± Ø£ÙŠ ÙˆØ¸ÙŠÙØ©
 */

import React, { createContext, useContext, useState, useEffect, useCallback } from 'react';
import { toast } from '@/hooks/use-toast';
import { useAuth } from '@/contexts/UnifiedAuthContext';
import { usePermissions } from '@/hooks/usePermissions';
import { useNotifications } from '@/contexts/NotificationsContext';
import { useNotificationsSystem } from '@/contexts/NotificationsSystemContext';
import { useCart } from '@/hooks/useCart.jsx';
import { supabase } from '@/integrations/supabase/client';
import superAPI from '@/api/SuperAPI';

const SuperContext = createContext();

export const useSuper = () => {
  const context = useContext(SuperContext);
  if (!context) {
    throw new Error('useSuper must be used within a SuperProvider');
  }
  return context;
};

// Ø¥Ø¶Ø§ÙØ© alias Ù„Ù„ØªÙˆØ§ÙÙ‚ Ø§Ù„Ø¹ÙƒØ³ÙŠ
export const useInventory = () => {
  return useSuper();
};

// Ø¯Ø§Ù„Ø© ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ employee_code
const filterDataByEmployeeCode = (data, user) => {
  if (!user) return data;
  
  // Ø§Ù„Ù…Ø¯ÙŠØ±ÙˆÙ† ÙŠØ±ÙˆÙ† ÙƒÙ„ Ø´ÙŠØ¡
  if (user.is_admin || ['super_admin', 'admin'].includes(user.role)) {
    return data;
  }
  
  const userEmployeeCode = user.employee_code;
  if (!userEmployeeCode) {
    console.warn('âš ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¯ÙˆÙ† employee_code:', user);
    return { ...data, orders: [], customers: [], profits: [], purchases: [] };
  }
  
  console.log('ğŸ” ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…ÙˆØ¸Ù:', userEmployeeCode);
  
  return {
    ...data,
    // ØªØµÙÙŠØ© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø­Ø³Ø¨ employee_code
    orders: data.orders?.filter(order => order.created_by === userEmployeeCode) || [],
    // ØªØµÙÙŠØ© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø­Ø³Ø¨ employee_code  
    customers: data.customers?.filter(customer => customer.created_by === userEmployeeCode) || [],
    // ØªØµÙÙŠØ© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø­Ø³Ø¨ employee_code
    profits: data.profits?.filter(profit => profit.employee_id === userEmployeeCode) || [],
    // ØªØµÙÙŠØ© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø­Ø³Ø¨ employee_code
    purchases: data.purchases?.filter(purchase => purchase.created_by === userEmployeeCode) || []
  };
};

export const SuperProvider = ({ children }) => {
  const { user } = useAuth();
  const { hasPermission } = usePermissions();
  const { addNotification } = useNotifications();
  const { notifyLowStock } = useNotificationsSystem();
  
  // Ø¥Ø¶Ø§ÙØ© ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø³Ù„Ø©
  const { cart, addToCart, removeFromCart, updateCartItemQuantity, clearCart } = useCart();
  
  // Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ­Ø¯Ø© - Ù†ÙØ³ Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø§Ù„Ø¶Ø¨Ø·
  const [allData, setAllData] = useState({
    products: [],
    orders: [],
    customers: [],
    purchases: [],
    expenses: [],
    profits: [],
    cashSources: [],
    settings: { 
      deliveryFee: 5000, 
      lowStockThreshold: 5, 
      mediumStockThreshold: 10, 
      sku_prefix: "PROD", 
      lastPurchaseId: 0,
      printer: { paperSize: 'a4', orientation: 'portrait' }
    },
    aiOrders: [],
    profitRules: [],
    colors: [],
    sizes: [],
    categories: [],
    departments: [],
    productTypes: [],
    seasons: []
  });
  
  const [loading, setLoading] = useState(true);
  const [accounting, setAccounting] = useState({ 
    capital: 10000000, 
    expenses: [] 
  });

  // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ­Ø¯Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ - Ù…Ø¹ ØªØµÙÙŠØ© employee_code
  const fetchAllData = useCallback(async () => {
    if (!user) return;
    
    try {
      setLoading(true);
      console.log('ğŸš€ SuperProvider: Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:', user.employee_code || user.user_id);
      
      const data = await superAPI.getAllData();
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      if (!data) {
        console.error('âŒ SuperProvider: Ù„Ù… ÙŠØªÙ… Ø¬Ù„Ø¨ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† SuperAPI');
        return;
      }
      
      // ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ employee_code Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†
      const filteredData = filterDataByEmployeeCode(data, user);
      
      console.log('âœ… SuperProvider: ØªÙ… Ø¬Ù„Ø¨ ÙˆØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­:', {
        products: filteredData.products?.length || 0,
        orders: filteredData.orders?.length || 0,
        customers: filteredData.customers?.length || 0,
        userEmployeeCode: user.employee_code || 'admin'
      });
      
      setAllData(filteredData);
      
      // ØªØ­Ø¯ÙŠØ« accounting Ø¨Ù†ÙØ³ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
      setAccounting(prev => ({
        ...prev,
        expenses: filteredData.expenses || []
      }));
      
    } catch (error) {
      console.error('âŒ SuperProvider: Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
      
      // ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ SuperAPIØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
      console.log('ğŸ”„ SuperProvider: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©...');
      
      try {
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ©
        const [products, orders, customers, colors, sizes, categories, departments] = await Promise.all([
          supabase.from('products').select(`
            *,
            product_variants (
              *,
              colors (id, name, hex_code),
              sizes (id, name, type),
              inventory (quantity, min_stock, reserved_quantity, location)
            )
          `).order('created_at', { ascending: false }),
          
          supabase.from('orders').select(`
            *,
            order_items (
              *,
              products (id, name, images),
              product_variants (
                id, price, cost_price, images,
                colors (name, hex_code),
                sizes (name)
              )
            )
          `).order('created_at', { ascending: false }),
          
          supabase.from('customers').select('*').order('created_at', { ascending: false }),
          supabase.from('colors').select('*').order('name'),
          supabase.from('sizes').select('*').order('name'),
          supabase.from('categories').select('*').order('name'),
          supabase.from('departments').select('*').order('name')
        ]);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        setAllData(prev => ({
          ...prev,
          products: products.data || [],
          orders: orders.data || [],
          customers: customers.data || [],
          colors: colors.data || [],
          sizes: sizes.data || [],
          categories: categories.data || [],
          departments: departments.data || []
        }));
        
        console.log('âœ… SuperProvider: ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ©');
        
      } catch (fallbackError) {
        console.error('âŒ SuperProvider: ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ©:', fallbackError);
      }
    } finally {
      setLoading(false);
    }
  }, [user]);

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
  useEffect(() => {
    fetchAllData();
  }, [fetchAllData]);

  // Ø¥Ø¹Ø¯Ø§Ø¯ Realtime Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ©
  useEffect(() => {
    if (!user) return;

    const handleRealtimeUpdate = (table, payload) => {
      console.log(`ğŸ”„ SuperProvider: ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ ÙÙŠ ${table}`);
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ ØªØ­Ø¯ÙŠØ«
      fetchAllData();
    };

    superAPI.setupRealtimeSubscriptions(handleRealtimeUpdate);

    return () => {
      superAPI.unsubscribeAll();
    };
  }, [user, fetchAllData]);

  // ===============================
  // ÙˆØ¸Ø§Ø¦Ù Ù…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ InventoryContext
  // ===============================

  // Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ - Ù†ÙØ³ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø§Ù„Ø¶Ø¨Ø·
  const createOrder = useCallback(async (customerInfo, cartItems, trackingNumber, discount, status, qrLink, deliveryPartnerData) => {
    try {
      const subtotal = cartItems.reduce((sum, item) => sum + item.quantity * item.price, 0);
      const deliveryFee = deliveryPartnerData?.delivery_fee || allData.settings?.deliveryFee || 0;
      const total = subtotal - (discount || 0) + deliveryFee;

      const orderData = {
        customer_name: customerInfo.name,
        customer_phone: customerInfo.phone,
        customer_address: customerInfo.address,
        customer_city: customerInfo.city,
        customer_province: customerInfo.province,
        total_amount: subtotal,
        discount: discount || 0,
        delivery_fee: deliveryFee,
        final_amount: total,
        status: 'pending',
        delivery_status: 'pending',
        payment_status: 'pending',
        tracking_number: trackingNumber || `RYUS-${Date.now().toString().slice(-6)}`,
        delivery_partner: deliveryPartnerData?.delivery_partner || 'Ù…Ø­Ù„ÙŠ',
        notes: customerInfo.notes,
        created_by: user?.user_id || user?.id,
      };

      const createdOrder = await superAPI.createOrder(orderData);
      
      return { 
        success: true, 
        trackingNumber: orderData.tracking_number, 
        qr_id: createdOrder.qr_id,
        orderId: createdOrder.id 
      };
      
    } catch (error) {
      console.error('Error in createOrder:', error);
      return { success: false, error: error.message };
    }
  }, [allData.settings, user]);

  // ØªØ­Ø¯ÙŠØ« Ø·Ù„Ø¨ - Ù†ÙØ³ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  const updateOrder = useCallback(async (orderId, updates) => {
    try {
      const updatedOrder = await superAPI.updateOrder(orderId, updates);
      return { success: true, data: updatedOrder };
    } catch (error) {
      console.error('Error in updateOrder:', error);
      return { success: false, error: error.message };
    }
  }, []);

  // Ø­Ø°Ù Ø·Ù„Ø¨Ø§Øª
  const deleteOrders = useCallback(async (orderIds, isAiOrder = false) => {
    try {
      // TODO: ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ SuperAPI
      console.log('ğŸ—‘ï¸ Ø­Ø°Ù Ø·Ù„Ø¨Ø§Øª:', orderIds);
      return { success: true };
    } catch (error) {
      console.error('Error deleting orders:', error);
      return { success: false, error: error.message };
    }
  }, []);

  // Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ - Ù†ÙØ³ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  const addExpense = useCallback(async (expense) => {
    try {
      console.log('ğŸ’° SuperProvider: Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ:', expense.description);
      
      // TODO: ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ SuperAPI
      toast({ 
        title: "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙ",
        description: `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ ${expense.description}`,
        variant: "success" 
      });

      return { success: true, data: expense };
    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙ:', error);
      throw error;
    }
  }, []);

  // Ø¯ÙˆØ§Ù„ Ø£Ø®Ø±Ù‰ Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„ØªÙˆØ§ÙÙ‚
  const refreshOrders = useCallback(() => fetchAllData(), [fetchAllData]);
  const refreshProducts = useCallback(() => fetchAllData(), [fetchAllData]);
  const approveAiOrder = useCallback(async (orderId) => ({ success: true }), []);

  // Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø±Ø¬Ø¹Ø© - Ù†ÙØ³ Ø¨Ù†ÙŠØ© InventoryContext Ø¨Ø§Ù„Ø¶Ø¨Ø· Ù…Ø¹ Ù‚ÙŠÙ… Ø¢Ù…Ù†Ø©
  const contextValue = {
    // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© - Ù…Ø¹ Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¢Ù…Ù†Ø©
    products: allData.products || [],
    orders: allData.orders || [],
    customers: allData.customers || [],
    purchases: allData.purchases || [],
    expenses: allData.expenses || [],
    profits: allData.profits || [],
    aiOrders: allData.aiOrders || [],
    settings: allData.settings || { 
      deliveryFee: 5000, 
      lowStockThreshold: 5, 
      mediumStockThreshold: 10, 
      sku_prefix: "PROD", 
      lastPurchaseId: 0,
      printer: { paperSize: 'a4', orientation: 'portrait' }
    },
    accounting: accounting || { capital: 10000000, expenses: [] },
    
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø´Ø­Ø§Øª - Ù…Ø¹ Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¢Ù…Ù†Ø©
    categories: allData.categories || [],
    departments: allData.departments || [],
    allColors: allData.colors || [],
    allSizes: allData.sizes || [],
    
    // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    loading: loading || false,
    
    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø³Ù„Ø© - Ù…Ù‡Ù…Ø© Ø¬Ø¯Ø§Ù‹ Ù…Ø¹ Ù‚ÙŠÙ… Ø¢Ù…Ù†Ø©
    cart: cart || [],
    addToCart: addToCart || (() => {}),
    removeFromCart: removeFromCart || (() => {}),
    updateCartItemQuantity: updateCartItemQuantity || (() => {}),
    clearCart: clearCart || (() => {}),
    
    // Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    createOrder: createOrder || (async () => ({ success: false })),
    updateOrder: updateOrder || (async () => ({ success: false })),
    deleteOrders: deleteOrders || (async () => ({ success: false })),
    addExpense: addExpense || (async () => ({ success: false })),
    refreshOrders: refreshOrders || (() => {}),
    refreshProducts: refreshProducts || (() => {}),
    approveAiOrder: approveAiOrder || (async () => ({ success: false })),
    
    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ù„Ù„ØªÙˆØ§ÙÙ‚)
    addProduct: () => console.log('addProduct - Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹'),
    updateProduct: () => console.log('updateProduct - Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹'),
    deleteProducts: () => console.log('deleteProducts - Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹'),
    updateVariantStock: () => console.log('updateVariantStock - Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹'),
    getLowStockProducts: () => [],
    
    // ÙˆØ¸Ø§Ø¦Ù Ø£Ø®Ø±Ù‰ Ù„Ù„ØªÙˆØ§ÙÙ‚
    calculateProfit: () => 0,
    calculateManagerProfit: () => 0,
  };

  // Ø¥Ø¶Ø§ÙØ© Ù„ÙˆÙ‚ Ù„Ù„ØªØªØ¨Ø¹
  console.log('ğŸ” SuperProvider contextValue:', {
    hasCart: !!contextValue.cart,
    cartLength: contextValue.cart?.length || 0,
    loading: contextValue.loading,
    hasProducts: !!contextValue.products,
    productsLength: contextValue.products?.length || 0
  });

  return (
    <SuperContext.Provider value={contextValue}>
      {children}
    </SuperContext.Provider>
  );
};