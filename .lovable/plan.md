
# خطة تحليل وإصلاح مشاكل المزامنة وعرض الفواتير

## المشاكل المكتشفة والحلول المقترحة

---

## المشكلة 1: مدن لا يتزامن يدوياً

### التشخيص
تم فحص الكود في `src/lib/modon-api.js` ووُجد أنه **تم تطبيق التعديلات** بشكل صحيح:
- يستخدم `supabase.functions.invoke('modon-proxy')` بدلاً من URL ثابت
- يستورد `supabase` من `./customSupabaseClient`

**لكن المشكلة الفعلية:** عند استدعاء Edge Function من المتصفح، يتطلب ذلك أن يكون المستخدم مُسجل دخوله (Authorization header).

### الحل
1. التأكد من أن `modon-api.js` يستخدم supabase client بشكل صحيح
2. التحقق من أن `modon-proxy` Edge Function تتعامل مع طلبات بدون JWT بشكل صحيح (للتوافق مع المزامنة اليدوية)

---

## المشكلة 2: التجديد التلقائي للتوكن لا يعمل

### التشخيص
- **وظيفة Cron موجودة:** `refresh-delivery-tokens-daily` مجدولة الساعة 08:00 صباحاً
- **لا توجد سجلات تجديد:** `background_sync_logs` لا تحتوي على أي سجل `sync_type = 'token_renewal'`
- **التوكنات صالحة:** توكن مدن صالح حتى 2026-02-10 (6 أيام متبقية) - **لا يحتاج تجديد الآن**

### المشكلة الجذرية
وظيفة التجديد مصممة لتجدد التوكنات التي تنتهي **خلال 24 ساعة القادمة فقط**:
```typescript
.gte('expires_at', now.toISOString()) // Not expired yet
.lte('expires_at', renewalThreshold.toISOString()); // Expires within 24 hours
```

**التوكن الحالي صالح لـ 6 أيام، لذا لن يتم تجديده حتى يتبقى يوم واحد فقط على الانتهاء.**

### الحل
- ✅ لا توجد مشكلة فعلية - النظام يعمل كما هو مصمم
- التجديد يحدث تلقائياً خلال آخر 24 ساعة من صلاحية التوكن
- يمكن إضافة **إشعار** للمستخدم عندما يقترب التوكن من الانتهاء (3 أيام مثلاً) للتوعية

---

## المشكلة 3: ربط الطلبات المحلية بالفاتورة

### التشخيص
تم فحص دالة `link_invoice_orders_to_orders` ووُجد أنها **تعمل بشكل صحيح**:
1. تبحث عن الطلبات باستخدام `tracking_number` أو `delivery_partner_order_id`
2. تتحقق من أهلية الطلب (غير مرجع/ملغي)
3. تربط فقط الطلبات الموجودة فعلاً في قاعدة البيانات

**النتيجة:** تم التحقق من أن الطلبات مربوطة بشكل صحيح (20 طلب مربوط بالفعل كما يظهر في الاستعلام)

```
invoice_external_id: 2819929 → customer_name: ازياء عبود الشمري (delivered) ✓
```

**الربط ليس عشوائياً** - يتم التحقق من وجود الطلب محلياً قبل الربط.

---

## المشكلة 4: فواتير عبدالله لا تظهر عند المدير (الأهم!)

### التشخيص
| العنصر | القيمة |
|--------|--------|
| معرف عبدالله | `d46021fe-8cde-4575-97ac-c2661ee91527` |
| أحدث فاتورة | `2819929` (84,000 دينار - 3 طلبات) |
| مشكلة `issued_at` | **NULL في أحدث الفواتير!** |

**الاستعلام الحالي في `AllEmployeesInvoicesView.jsx`:**
```javascript
.gte('issued_at', new Date(Date.now() - 90 * 24 * 60 * 60 * 1000).toISOString())
```

**المشكلة الجذرية:**
الفواتير الحديثة (2819929 و 2795763) ليس لديها قيمة `issued_at` محددة، بينما الاستعلام يفلتر على `issued_at >= 90 يوم مضى`.

**النتيجة:** الفواتير الحديثة لا تظهر للمدير لأن `issued_at IS NULL`.

### الحل
تعديل الاستعلام ليستخدم `created_at` كبديل عندما يكون `issued_at` غير موجود، أو استخدام `COALESCE(issued_at, created_at)`:

```javascript
// قبل
.gte('issued_at', new Date(Date.now() - 90 * 24 * 60 * 60 * 1000).toISOString())

// بعد
.or(`issued_at.gte.${threshold},and(issued_at.is.null,created_at.gte.${threshold})`)
```

**أو الأفضل:** إصلاح `smart-invoice-sync` لضمان ملء `issued_at` دائماً من `invoice.created_at` أو `created_at` المحلي.

---

## ملخص التغييرات المطلوبة

| الملف | التعديل | الأولوية |
|-------|---------|----------|
| `src/components/orders/AllEmployeesInvoicesView.jsx` | تعديل استعلام الفواتير ليشمل `issued_at IS NULL` مع فلترة `created_at` | عالية |
| `supabase/functions/smart-invoice-sync/index.ts` | التأكد من ملء `issued_at` من `invoice.created_at` | عالية |
| `src/lib/modon-api.js` | التحقق من عمل المزامنة اليدوية وإضافة logging أفضل | متوسطة |

---

## ملاحظات إضافية

### التجديد التلقائي للتوكن
- **يعمل بشكل صحيح** ✅
- مجدول الساعة 08:00 صباحاً يومياً
- يجدد التوكنات التي تنتهي خلال 24 ساعة فقط
- التوكن الحالي صالح لـ 6 أيام، لذا لا يحتاج تجديد حالياً

### ربط الطلبات بالفواتير
- **يعمل بشكل صحيح** ✅
- يتحقق من وجود الطلب محلياً قبل الربط
- يستخدم `tracking_number` للمطابقة
- لا يربط الطلبات المرجعة أو الملغاة

### عبدالله في employee_supervisors
- **موجود ومربوط** ✅
- `supervisor_id: 91484496...` (المدير العام)
- `employee_id: d46021fe...` (عبدالله)

---

## خطوات التنفيذ

1. **إصلاح فلتر `issued_at`** في `AllEmployeesInvoicesView.jsx`:
   - استخدام `created_at` كبديل عندما يكون `issued_at` غير موجود

2. **تحسين `smart-invoice-sync`**:
   - ضمان ملء `issued_at` من بيانات API أو `created_at` المحلي

3. **اختبار يدوي**:
   - تسجيل الدخول كمدير
   - التحقق من ظهور فواتير عبدالله الحديثة
   - اختبار المزامنة اليدوية لمدن
