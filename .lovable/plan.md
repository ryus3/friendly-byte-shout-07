

# خطة إصلاح عرض الوقت في واجهة إعدادات المزامنة

## المشكلة المكتشفة

### السبب الجذري
عند قراءة إعدادات المزامنة، الكود يستخدم:
```javascript
supabase.from('auto_sync_schedule_settings').select('*').maybeSingle()
```

لكن جدول `auto_sync_schedule_settings` يحتوي على **صفين**:

| ID | sync_times | ملاحظة |
|----|-----------|--------|
| `af158c1a-...` | `[02:15:00, 21:00:00]` | صف قديم (غير مستخدم) |
| `00000000-...` | `[09:00, 23:45]` | **الصف الصحيح** ✅ |

دالة `maybeSingle()` تتوقع صفًا واحدًا أو لا شيء. عندما تجد صفين، قد ترجع `null` أو الصف الأول (الخاطئ)، مما يجعل الواجهة تعرض القيم الافتراضية `09:00` و `21:00`.

---

## الحل

### التعديل المطلوب

تعديل السطر 85 في `InvoiceSyncSettings.jsx` لقراءة الصف الصحيح تحديداً:

**قبل:**
```javascript
supabase.from('auto_sync_schedule_settings').select('*').maybeSingle()
```

**بعد:**
```javascript
supabase
  .from('auto_sync_schedule_settings')
  .select('*')
  .eq('id', '00000000-0000-0000-0000-000000000001')
  .single()
```

---

## التفاصيل التقنية

### لماذا يعمل المزامنة بشكل صحيح في الخلفية؟
دالة `update_invoice_sync_schedule` تُحدّث الصف الصحيح مباشرة وتُحدّث الـ cron jobs بشكل صحيح. الـ cron jobs الحالية:

- **ID 63** `smart-invoice-sync-morning`: `0 6 * * *` (06:00 UTC = 09:00 بغداد) ✅
- **ID 64** `smart-invoice-sync-evening`: `45 20 * * *` (20:45 UTC = 23:45 بغداد) ✅

### ماذا يحدث بعد الإصلاح؟
1. عند فتح صفحة الإعدادات، الكود يقرأ الصف الصحيح فقط
2. `sync_times = ['09:00', '23:45']`
3. الواجهة تعرض: `09:00` للصباح و `23:45` للمساء

---

## الملفات المطلوب تعديلها

**`src/components/settings/InvoiceSyncSettings.jsx`** - السطر 85:
- تغيير الاستعلام لقراءة الصف الصحيح بواسطة الـ ID المحدد

---

## اختياري: تنظيف قاعدة البيانات

لتجنب أي ارتباك مستقبلي، يمكن حذف الصف القديم غير المستخدم:

```sql
DELETE FROM auto_sync_schedule_settings 
WHERE id = 'af158c1a-3dc6-4f73-9b87-c3096e6a988f';
```

وأيضاً حذف الـ cron jobs المكررة القديمة:

```sql
SELECT cron.unschedule(17);  -- smart-invoice-sync-morning القديمة
SELECT cron.unschedule(18);  -- smart-invoice-sync-evening القديمة
```

---

## النتيجة المتوقعة

| ما تختاره | ما يُحفظ في DB | ما يظهر في الواجهة |
|-----------|---------------|-------------------|
| 09:00 صباحاً | `['09:00', ...]` | **09:00 ص** ✅ |
| 23:45 مساءً | `[..., '23:45']` | **23:45 م** ✅ |

