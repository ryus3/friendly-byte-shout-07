
هدف التعديل
- المزامنة تعمل فعلاً بالوقت الذي تختاره (هذا ممتاز).
- المشكلة المتبقية فقط بالواجهة: وقت “مزامنة الصباح/المساء” يبقى على القيمة الافتراضية (09:00 و 21:00) بدل قراءة الوقت المحفوظ من قاعدة البيانات.

التشخيص (سبب المشكلة الحقيقي)
- في `InvoiceSyncSettings.jsx` يتم جلب الجدولة هكذا:
  - `supabase.from('auto_sync_schedule_settings').select('*').maybeSingle()`
- لكن جدول `auto_sync_schedule_settings` عندك يحتوي صفّين (تم التحقق في بيئة test):
  - `00000000-0000-0000-0000-000000000001` → `sync_times: ['09:00','23:45']` (هذا الصف الصحيح الذي نحدثه دائماً)
  - `af158c1a-3dc6-4f73-9b87-c3096e6a988f` → `sync_times: ['02:15:00','21:00:00']` (صف قديم)
- عند وجود أكثر من صف، `maybeSingle()` لا تعطي نتيجة “مضمونة” وقد ترجع `null` أو خطأ، فيسقط الكود على القيم الافتراضية:
  - morning = '09:00'
  - evening = '21:00'
- لذلك الواجهة تبقى تعرض 9:00 (صباحاً) و 9:00 (مساءً = 21:00) حتى لو كانت الجدولة تعمل بوقت مختلف.

ملاحظة مهمة إضافية (ليست سبب وقت الواجهة، لكنها قد تسبب لبس)
- جدول `cron.job` عندك يحتوي نسختين لنفس اسم الـ job:
  - morning: jobid 17 و jobid 63
  - evening: jobid 18 و jobid 64
- دالة `get_invoice_cron_status()` حالياً ترجع الاثنين لأنّها تعمل فلترة بالاسم فقط، وليس على “آخر job” أو “الـ job الصحيح”.
- هذا لا يغير قيمة الوقت في Inputs، لكنه قد يجعل قسم “حالة المهام المجدولة” يعرض أكثر من سطر أو يعرض جدول قديم.

التنفيذ المقترح (تصحيح الواجهة لتقرأ الوقت الصحيح دائماً)
1) تعديل الاستعلام داخل `src/components/settings/InvoiceSyncSettings.jsx`
   - بدلاً من قراءة أي صف من `auto_sync_schedule_settings`، سنقرأ الصف الصحيح مباشرة بالـ ID الثابت:
     - `eq('id', '00000000-0000-0000-0000-000000000001')`
   - مع استخدام `maybeSingle()` (أو `single()` مع معالجة الخطأ) بحيث:
     - إذا لم يوجد الصف لأي سبب: نُظهر Toast/تنبيه واضح + نستخدم fallback.
     - إذا وجد: نقرأ `sync_times` ونحدث `settings.morning_sync_time` و `settings.evening_sync_time`.

   لماذا هذا كافٍ؟
   - لأن `update_invoice_sync_schedule()` أصلاً يكتب دائماً في هذا الـ ID:
     - `WHERE id = '00000000-0000-0000-0000-000000000001'`
   - فمجرّد أن الواجهة تقرأ منه بشكل صريح، ستعرض نفس الوقت الذي اخترته بلا أي افتراضات.

2) تحسين صغير لتجربة المستخدم (اختياري لكن مفيد)
   - عند نجاح “حفظ إعدادات الجدولة”، بدلاً من انتظار `fetchAllData()` فقط:
     - نحدّث الـ state مباشرة بالقيم التي اختارها المستخدم (هي أصلاً موجودة في state)
     - ثم نجلب البيانات لتأكيدها (كما هو الآن).
   - الهدف: حتى لو تأخر الجلب أو فشل مرة، تبقى الواجهة تعرض ما اختاره المستخدم.

التنفيذ المقترح (اختياري) لتصفية عرض الـ Cron Jobs في الواجهة
3) تحديث دالة `public.get_invoice_cron_status()` لتعرض “آخر job فقط” لكل اسم
   - لأن عندك jobid قديم وجديد بنفس الاسم، نريد إظهار الأحدث فقط (الأكبر jobid عادةً).
   - التعديل سيكون داخل SQL migration:
     - بدل `WHERE jobname IN (...)` فقط
     - نستخدم subquery/CTE لاختيار `max(jobid)` لكل `jobname` ثم نرجع تلك الصفوف فقط.
   - هذا لا يغيّر تشغيل المزامنة (أنت قلت كل شيء يعمل)، لكنه يمنع الواجهة من عرض بيانات مضللة أو مكررة.

التحقق الإلزامي بعد التنفيذ (Verification عميق كما تحب)
A) تحقق من قاعدة البيانات (Test environment)
- تشغيل:
  - `select id, sync_times, updated_at from public.auto_sync_schedule_settings order by updated_at desc;`
- التأكد أن الصف `0000...0001` يحتوي الوقت الذي اخترته فعلاً.

B) تحقق من الواجهة
- افتح “لوحة تحكم مزامنة الفواتير” > تبويب “الجدولة”.
- تأكد أن حقول الوقت تعرض نفس `sync_times` المخزنة (بدون رجوع إلى 09:00/21:00).
- غيّر الوقت واحفظ:
  - أعد تحميل الصفحة (Refresh).
  - تأكد أن الوقت يبقى كما اخترته.

C) تحقق من “حالة المهام المجدولة” (إن طبقنا خطوة 3)
- تأكد أنه يظهر سطر واحد للصباح وسطر واحد للمساء (بدون تكرار).
- لا نحتاج حذف jobs القديمة طالما لا نعرضها ولا نعتمد عليها.

الملفات التي سيتم تعديلها
- Frontend:
  - `src/components/settings/InvoiceSyncSettings.jsx`
    - تعديل استعلام جلب `auto_sync_schedule_settings` ليقرأ صف ID الثابت.
    - (اختياري) تحسين التعامل مع الأخطاء/الـ fallback و UX بعد الحفظ.
- Database (اختياري لتحسين عرض الحالة فقط):
  - SQL migration لتحديث `public.get_invoice_cron_status()` ليختار آخر job لكل اسم.

مخاطر/ملاحظات
- لا يوجد أي تغيير في منطق الجدولة أو تشغيل المزامنة نفسه (لأنها تعمل صحيح بالفعل).
- التعديل الأساسي فقط يضمن أن الواجهة تقرأ “المصدر الصحيح” بدل الاعتماد على `maybeSingle()` مع وجود صفين.

تسلسل التنفيذ المقترح
1) تعديل `InvoiceSyncSettings.jsx` (الاستعلام) + معالجة fallback/التوست.
2) اختبار الواجهة مباشرة (refresh + تغيير وقت + حفظ).
3) (اختياري) تحديث `get_invoice_cron_status()` لمنع التكرار في عرض الـ jobs.
4) إعادة اختبار الواجهة وتأكيد أن كل شيء يظهر مطابقاً للوقت الذي تختاره.
