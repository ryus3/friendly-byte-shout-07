

# ุชุญููู ูุดููุฉ ูุฒุงููุฉ ุทูุจ ูุฏู #2616423

## โ ุฅุฌุงุจุงุช ุนูู ุฃุณุฆูุชู:

### 1. ูู ูุฏู ููุฌูุฏ ูู ูุฒุงููุฉ ุญุงูุฉ ุงูุทูุจุงุช ุงูุชููุงุฆูุฉ (cron)ุ
**ูุนูุ ููุฌูุฏ ููุนูู!**

| ุงูู Cron Job | ูุฏุนู ูุฏูุ | ุงูููุงุญุธุงุช |
|-------------|----------|-----------|
| `sync-order-updates-scheduled` (ูู ุฏูููุฉ) | โ ูุนู | ูุณุชุฏุนู `check_and_run_sync()` ุงูุชู ุชุดุบู `sync-order-updates` |
| `sync-order-updates` Edge Function | โ ูุนู | ุงูุณุทุฑ 88: `.in('partner_name', ['alwaseet', 'modon'])` |

### 2. ูู ูุฏู ููุฌูุฏ ูู ูุฒุงููุฉ ุงูููุงุชูุฑ ุงูุชููุงุฆูุฉุ
**ูุนูุ ููุฌูุฏ ููุนูู!**

| ุงูู Cron Job | ูุฏุนู ูุฏูุ | ุงูููุงุญุธุงุช |
|-------------|----------|-----------|
| `smart-invoice-sync-morning` (06:00 UTC) | โ ูุนู | ูุณุชุฏุนู `smart-invoice-sync` |
| `smart-invoice-sync-evening` (20:45/21:00 UTC) | โ ูุนู | ููุณ ุงูุฏุงูุฉ |
| `smart-invoice-sync` Edge Function | โ ูุนู | ูุฏุนู ููุง ุงูุดุฑูุชูู (ุงูุณุทูุฑ 45-73) |

---

## โ ููุงุฐุง ุงูุทูุจ #2616423 ูุง ูุธูุฑ ุงูุฎุตูุ

### ุงูุณุจุจ ุงูุฌุฐุฑู:
**ุงูุณุนุฑ ุชู ุชุญุฏูุซู 8 ูุฑุงุช ูุจู ุฅุถุงูุฉ ููุทู ุญุณุงุจ ุงูุฎุตู!**

```text
ุงูููุงุญุธุงุช ูู ุงูุทูุจ:
[2026-01-30T01:15:12] ุงูุณุนุฑ ุชุบูุฑ ูู 33,000 ุฅูู 30,000 ุฏ.ุน
[2026-01-30T01:25:19] ุงูุณุนุฑ ุชุบูุฑ ูู 33,000 ุฅูู 30,000 ุฏ.ุน  โ ุขุฎุฑ ุชุญุฏูุซ
```

**ุงููุดููุฉ:**
1. ุงูุฅุตูุงุญ ุงูุฐู ุฃุถููุงู ูุนูู ููุท ุนูุฏ **ุงูุชุดุงู ุชุบููุฑ ุงูุณุนุฑ**
2. ุญุงููุงู: `currentFinalAmount (30,000) === newFinalAmount (30,000)`
3. ูุฐูู: **ูุง ูุฏุฎู ูู ุงูู if block** ููุง ูุญุณุจ ุงูุฎุตู!

### ุงูุญุณุงุจ ุงูุตุญูุญ (ูุฏููุงู):
```text
ุงูุณุนุฑ ุงูุฃุตูู ููููุชุฌุงุช (ูู order_items): 28,000 ุฏ.ุน
ุงูุณุนุฑ ุงูุฌุฏูุฏ (total_amount): 25,000 ุฏ.ุน
ุงููุฑู = 28,000 - 25,000 = 3,000 ุฏ.ุน (ุฎุตู) โ
```

---

## ๐๏ธ ุงูุฅุตูุงุญ ุงููุทููุจ

### ุงููุฑุญูุฉ 1: ุฅุตูุงุญ ูุฏูู ููุทูุจ ุงูุญุงูู (SQL)
```sql
UPDATE orders 
SET 
  discount = 3000,
  price_increase = 0,
  price_change_type = 'discount',
  updated_at = NOW()
WHERE tracking_number = '2616423';
```

### ุงููุฑุญูุฉ 2: ุฅุตูุงุญ ุงูููุฏ ูููุน ุงูุชูุฑุงุฑ (Edge Function)
**ุงููุดููุฉ:** ุงูููุฏ ููุญุต ุชุบููุฑ `final_amount` ููุทุ ููู ุฅุฐุง ุชู ุงูุชุญุฏูุซ ูุจู ุงูุฅุตูุงุญ โ ุงูุฎุตู ูุง ููุญุณุจ.

**ุงูุญู:** ุฅุถุงูุฉ ููุทู ููุชุญูู ูู ุฃู ุงูุฎุตู/ุงูุฒูุงุฏุฉ ูุญุณูุจุฉ ุญุชู ูู ุงูุณุนุฑ ูู ูุชุบูุฑ:

```typescript
// ูู supabase/functions/sync-order-updates/index.ts
// ุฅุถุงูุฉ ุดุฑุท ุฌุฏูุฏ:

const priceNeedsRecalculation = 
  !isPartialDelivery && 
  newFinalAmount > 0 && 
  (localOrder.discount === 0 || localOrder.discount === null) &&
  (localOrder.price_change_type === null);

if (!isPartialDelivery && newFinalAmount > 0 && 
    (currentFinalAmount !== newFinalAmount || priceNeedsRecalculation)) {
  // ... ููุฏ ุญุณุงุจ ุงูุฎุตู ุงูููุฌูุฏ ...
}
```

---

## ููุฎุต ุงูุชุนุฏููุงุช ุงููุทููุจุฉ

| ุงูุฎุทูุฉ | ุงูููุน | ุงูููู/ุงูุฌุฏูู | ุงููุตู |
|--------|------|-------------|-------|
| 1 | SQL | `orders` | ุชุญุฏูุซ ูุฏูู ููุทูุจ 2616423 ูุฅุถุงูุฉ ุงูุฎุตู |
| 2 | Edge Function | `sync-order-updates/index.ts` | ุฅุถุงูุฉ ุดุฑุท `priceNeedsRecalculation` |

---

## ุงูุงุฎุชุจุงุฑ ุจุนุฏ ุงูุฅุตูุงุญ

1. ุชุดุบูู ุงููุฒุงููุฉ: `curl /sync-order-updates`
2. ุงูุชุญูู ูู ุงูุทูุจ 2616423 ูุธูุฑ `discount = 3000`
3. ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ ูู ูุฏู ูุชุบููุฑ ุณุนุฑู ููุชุญูู ูู ุงูุญุณุงุจ ุงูุชููุงุฆู

